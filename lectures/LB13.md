
# Урок 12 по SQL: Порядок выполнения запроса

Теперь, когда у нас есть представление обо всех частях запроса, мы можем поговорить о том, как все они сочетаются друг с другом в контексте завершенного запроса.

Завершить запрос SELECT
``` sql
SELECT DISTINCT column, AGG_FUNC(_column_or_expression_), … 
FROM mytable 
JOIN another_table 
ON mytable.column = another_table.column 
WHERE _constraint_expression_ 
GROUP BY column 
HAVING _constraint_expression_ 
ORDER BY _column_ ASC/DESC 
LIMIT _count_ OFFSET _COUNT_;
```
Каждый запрос начинается с поиска нужных нам данных в базе данных, а затем фильтрации этих данных до чего-то, что может быть обработано и понято как можно быстрее. Поскольку каждая часть запроса выполняется последовательно, важно понимать порядок выполнения, чтобы вы знали, какие результаты где доступны.

# Порядок выполнения запроса

## 1.  `FROM`  и  `JOIN`s

Сначала выполняется  `FROM`  предложение и последующие  `JOIN`  предложения, чтобы определить общий рабочий набор данных, который запрашивается. Это включает в себя подзапросы в этом предложении и может привести к созданию временных таблиц под капотом, содержащих все столбцы и строки объединяемых таблиц.

## 2.  `WHERE`

Как только у нас будет полный рабочий набор данных, к отдельным строкам применяются ограничения первого прохода  `WHERE`, а строки, которые не удовлетворяют ограничению, отбрасываются. Каждое из ограничений может обращаться только к столбцам непосредственно из таблиц, запрошенных в  `FROM`  предложении. Псевдонимы в  `SELECT`  части запроса недоступны в большинстве баз данных, поскольку они могут включать выражения, зависящие от частей запроса, которые еще не были выполнены.

## 3.  `GROUP BY`

Затем оставшиеся строки после применения  `WHERE`  ограничений группируются на основе общих значений в столбце, указанном в  `GROUP BY`  предложении. В результате группировки будет столько строк, сколько уникальных значений в этом столбце. Неявно это означает, что вам нужно использовать это только тогда, когда у вас есть агрегатные функции в вашем запросе.

## 4.  `HAVING`

Если запрос содержит  `GROUP BY`  предложение, то ограничения в  `HAVING`  предложении затем применяются к сгруппированным строкам, отбрасывайте сгруппированные строки, которые не удовлетворяют ограничению. Как и предложение  `WHERE`, псевдонимы также недоступны на этом шаге в большинстве баз данных.

## 5.  `SELECT`

Все выражения в  `SELECT`  части запроса вычисляются в конечном итоге.

## 6.  `DISTINCT`

Из оставшихся строк будут удалены строки с повторяющимися значениями в столбце, помеченном как  `DISTINCT`.

## 7.  `ORDER BY`

Если порядок указан в предложении  `ORDER BY`, строки затем сортируются по указанным данным в порядке возрастания или убывания. Поскольку все выражения в  `SELECT`  части запроса были вычислены, вы можете ссылаться на псевдонимы в этом предложении.

## 8.  `LIMIT`  /  `OFFSET`

Наконец, строки, которые выходят за пределы диапазона, указанного с помощью  `LIMIT`  и  `OFFSET`, отбрасываются, оставляя окончательный набор строк, который будет возвращен из запроса.

## Заключение

Не каждый запрос должен содержать все части, перечисленные выше, но часть того, почему SQL настолько гибкий, заключается в том, что он позволяет разработчикам и аналитикам данных быстро манипулировать данными без необходимости написания дополнительного кода, и все это просто с помощью приведенных выше предложений.

# Упражнение

На этом заканчиваются наши уроки по  `SELECT`  запросам, поздравляем с тем, что зашли так далеко! Это упражнение попытается проверить ваше понимание запросов, поэтому не расстраивайтесь, если они покажутся вам сложными. Просто старайтесь изо всех сил.
## Упражнение 12 —  Задачи

1.  Найдите количество фильмов, снятых каждым режиссером
2.  Найдите общий объем внутренних и международных продаж, который может быть отнесен к каждому директору